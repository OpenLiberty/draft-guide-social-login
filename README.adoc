//  Copyright (c) 2017, 2019 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//
:projectid: social-login
:page-layout: guide-multipane
:page-duration: 30 minutes
:page-releasedate: 2017-09-19
:page-essential: true
:page-essential-order: 1
:page-description: Learn how to authenticate users with the Open Liberty Social Media Login feature.
:guide-author: Open Liberty
:page-tags: ['Java EE', 'Jakarta EE', 'Security']
:page-related-guides: ['microprofile-jwt', 'security-intro', 'rest-client-java', 'rest-client-angularjs']
:page-permalink: /guides/{projectid}
:page-seo-title: Authenticating users with Social Login
:page-seo-description: A tutorial on how to authenticate users in Open Liberty using the Social Media Login feature
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/master
= Authenticating users with Social Login

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website^].

Learn how to authenticate users with the Open Liberty Social Media Login feature.

== What you'll learn

You will learn how to authenticate users to an existing service using Social Media Login.

Social Media Login provides a form of single sign-on (SSO) that enables users to sign in to a secured website by using
their existing social media account.
It simplifies the authentication process for end users and allows you to provide a secure authentication
method for your users without having to explicitly implement it.

The https://openliberty.io/docs/ref/feature/#socialLogin-1.0.html[Social Media Login Feature^] in Open Liberty
enables you to configure application authentication using one or more social media platforms,
including GitHub, LinkedIn, Facebook, Twitter and Google.
You can also create custom configuration for any other social media platform that implements
the https://oauth.net/2[OAuth 2.0^] or https://openid.net/connect[OpenID Connect 1.0^] standard for authorization.`

By the end of this guide, you will be able to authenticate users to your web service using GitHub.

// =================================================================================================
// Getting Started
// =================================================================================================
[role='command']
include::{common-includes}/gitclone.adoc[]

== Creating a GitHub OAuth2 Application

Obtain an OAuth 2.0 client ID and client secret credentials for accessing the GitHub developer API by registering
a new https://github.com/settings/developers[application^] in your https://github.com/[GitHub^] account.
On the Settings > Developer settings > OAuth Apps page of your account, register a new application.

Set the Homepage URL to `\https://localhost:9443` and
the Authorization callback URL to `\https://localhost:9443/ibm/api/social-login/redirect/githubLogin`.

When the registration is complete, the client ID and client secret credentials are displayed.
Youâ€™ll need these two values later in the guide to authenticate your application with GitHub.

== Creating a secured servlet

The `hello.html` page contains a [hotspot=login file=2]`login` button that redirects to the
[hotspot=request file=2]`/hello` endpoint.
We will create a servlet to handle `GET` requests to this endpoint that requires that users be authenticated.
When users access this endpoint by clicking on the `login` button, they will be prompted to authenticate using GitHub.

First, navigate to the `start` directory.

[role='command']
include::{common-includes}/devmode-start.adoc[]

[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `HelloServlet` class.#
`src/main/java/io/openliberty/guides/sociallogin/HelloServlet.java`
----

The [hotspot=WebServletImport hotspot=WebServlet file=0]`@WebServlet` annotation declares that the
[hotspot=HelloServlet file=0]`HelloServlet` class, which must extend
[hotspot=HttpServlet hotspot=HttpServletImport file=0]`HttpServlet`, is a servlet.

The [hotspot=ServletSecurity hotspot=ServletSecurityImport file=0]`@ServletSecurity` annotation specifies the security
constraints.
The [hotspot=HttpConstraint hotspot=HttpConstraintImport file=0]`@HttpConstraint` annotation passed to the `value` element
configures the constraint for all HTTP methods in this servlet.

The [hotspot=rolesAllowed file=0]`rolesAllowed` element restricts the access to members of the `users` role.

The [hotspot=doGet file=0]`doGet()` method handles GET requests to this servlet.
The [hotspot=getUsername file=0]`username` of the user is added to the request as an attribute to be used by the
[hotspot=username file=1]`securedHello.jsp` page, to which the request is [hotspot=forwardRequest]`forwarded`
by the servlet.

HelloServlet.java
[source, Java, linenums, role='code_column hide_tags=copyright']
----
include::finish/src/main/java/io/openliberty/guides/sociallogin/HelloServlet.java[]
----

securedHello.jsp
[source, html, linenums, role='code_column hide_tags=copyright']
----
include::finish/src/main/webapp/securedHello.jsp[]
----

hello.html
[source ,html, linenums, role='code_column hide_tags=copyright']
----
include::finish/src/main/webapp/hello.html[]
----

== Implementing logout

The [file=1]`securedHello.jsp` page contains a [hotspot=logoutButton file=1]`logout` button that makes a `POST` request
to the [hotspot=logout file=1]`/logout` endpoint.
We will create a servlet to handle [hostpot=handlePost file=0]`POST` requests to this endpoint.
Similar to `HelloServlet`, this servlet also requires that the user be authenticated.

----
#Create the `LogoutServlet` class.#
`src/main/java/io/openliberty/guides/sociallogin/HelloServlet.java`
----

The [hotspot=WebServlet file=0]`@WebServlet` and [hotspot=ServletSecurity file=0]`@ServletSecurity` annotations declare
that the `LogoutServlet` class is a servlet that handles the `/logout` endpoint whose access is restricted to members of
the role `users`.

Before the user is logged out of the application, the access token obtained by Social Login from the social media provider
as part of the authentication can be used to revoke user permissions for the application. When the user logs into the
application again, they will be prompted to authorize the application.

[role="code_command", subs="quotes"]
----
#Update the `LogoutServlet` class.#
`src/main/java/io/openliberty/guides/sociallogin/HelloServlet.java`
----
[role="edit_command_text"]
Replace [hotspot=clientId file=0]`[github-client-id]` and [hotspot=clientSecret file=0]`[github-client-secret]` with
the client ID and client secret for your GitHub OAuth2 application.

The access token is retrieved using the [hotspot=accessToken file=0]`UserProfileManager`.

Basic Authorization is used to access the [hotspot=unauthorizeUrl file=0]`url` to delete an application grant.
The username and password for basic authorization are the GitHub client ID and client secret.
To construct the authorization header, the client ID and client secret must be [hotspot=encodeAuth file=0]`encoded`.

The `DELETE` request to the [hotspot=unauthorizeUrl file=0]`unauthorizeUrl` is performed using the JAX-RS
[hotspot=revokePermissions hotspot=target file=0]`ClientBuilder`. The [hotspot=encodeAuth file=0]`encoded` client ID and
client secret is added to the request as an [hotspot=authHeader file=0]`Authorization: Basic ...` header.
The [hotspot=accessToken file=0]`access token` is sent as part of the
[hotspot=requestBody hotspot=accessTokenBody file=0]`request body`.

Lastly, the [hotspot=logout file=0]`HttpServletRequest#logout()` method is used to log the user out of the application, after which the user
is [hotspot=redirect file=0]`redirected` to `hello.html`.

LogoutServlet.java
[source, Java, linenums, role='code_column hide_tags=copyright']
----
include::finish/src/main/java/io/openliberty/guides/sociallogin/LogoutServlet.java[]
----

securedHello.jsp
[source, html, linenums, role='code_column hide_tags=copyright']
----
include::finish/src/main/webapp/securedHello.jsp[]
----

== Configuring security and social media login

[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the server configuration file.#
`src/main/liberty/config/server.xml`
----

server.xml
[source, xml, linenums, role='code_column']
----
include::finish/src/main/liberty/config/server.xml[]
----

The explanations for these changes are in the following sections.

=== Configuring the security role

The [hotspot=applicationBnd]`<application-bnd />` configuration element under the
[hotspot=webApplication]`<webApplication />` configuration element creates a new security role [hotspot=users]`users`,
which all authenticated users belong to.
Adding this allows users that are authenticated using social media login to access your `HelloService` service.

=== Required features

To enable https://openliberty.io/docs/ref/feature/#socialLogin-1.0.html[Social Media Login feature^] and other required features,
new [hotspot=newFeatures]`<feature />` elements are added to the [hotspot=featureManager]`<featureManager />` in
`server.xml`.

There are some prerequisite configurations that social media login configuration elements need:

1. The [hotspot=keystore]`<keyStore id="defaultKeyStore" .../>` configuration element
corresponds to the keystore created in the prerequisites section
2. An [hotspot=sslConfig]`<ssl id="authServiceSslRef .../>` configuration element for configuring the SSL configuration that is used to connect to the social media

=== Configuring keystore and SSL

The [hotspot=keystore]`<keyStore id="defaultKeyStore" .../>` configuration element
will be used to provide SSL certificates when initiating HTTPS connections for social media login.

[role="code_command hotspot=sections", subs="quotes"]
----
#Update the `server.xml` file.#
`src/liberty/config/server.xml`
----
[role="edit_command_text"]
Replace [hotspot=22]`[keystore-password]` with the password that you used when creating the keystore in the previous
sections.

The [hotspot=sslConfig]`<ssl id="authServiceSslRef" .../>` configuration element, which references
[hotspot=keystore]`<keyStore id="defaultKeyStore" .../>` as the keystore, will be provided to social media login
configurations.

For your application to send data securely to GitHub, it must trust the public SSL certificates
provided by it.
This requires the SSL certificates for GitHub to be added to a truststore.

Since GitHub in this guide use a well-known CA (Certificate Authority), they can be
found in the JDK default `cacerts` file.

The [hotspot=30]`trustDefaultCerts` attribute of the [hotspot=sslConfig]`<ssl id="authServiceSslRef" .../>`
configuration element, when set to true, allows the server to establish trust using the JDK default truststore,
instead of requiring you to create a truststore with the required certificates.

=== Adding GitHub login configuration

[role="code_command hotspot=sections", subs="quotes"]
----
#Update the `server.xml` file.#
`src/liberty/config/server.xml`
----
[role="edit_command_text"]
Replace [hotspot=33]`[client-id]` and [hotspot=34]`[client-secret]` with the credentials you created for
your GitHub application in the prerequisites section.

The [hotspot=githubLogin]`<githubLogin />` configuration element will configure GitHub login.
The [hotspot=38]`sslRef` attribute is set to the [hotspot=sslConfig]`authServiceSslRef` configuration from the previous
section.

== Running the application

The Open Liberty server was started in development mode at the beginning of the guide and all the
changes were automatically picked up.

Check out the service that you created at the
http://localhost:9080/api/hello[^] URL.

Try logging in using your social media account.
After authenticating, you will be redirected back to https://localhost:9080/api/hello and the response will look like this:

[source,role="no_copy"]
----
Hello, <<your username>>
----

== Testing the service

No automated tests are provided in this guide.
You can test this service manually by starting a server and pointing a web browser at http://localhost:9080/api/hello[the endpoint for Hello service^].

== Great work! You're done!

You secured a simple RESTful web service in Open Liberty by using the Social Media Login feature.

== Next Steps

If more than one is added, thereâ€™s a selection form presented to the user, where all the possible social media providers
configured in your application are shown for the user to pick from. As an exercise, configure a second social media
provider, Facebook, for social media login for your application.

For more information, refer to the
https://www.openliberty.io/docs/ref/feature/#socialLogin-1.0.html[OpenLibery Social Media Login feature documentation^].

== Related Links

Learn more about MicroProfile.

https://microprofile.io/[See the MicroProfile specs^]

https://openliberty.io/docs/ref/microprofile[View the MicroProfile API^]


include::{common-includes}/attribution.adoc[subs="attributes"]
